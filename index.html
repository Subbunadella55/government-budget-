<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Government Budget Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --background-color: #e8f5e9;
            --card-background: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
            --hover-color: #45a049;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            width: 100%;
            margin: 20px;
            padding: 30px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            min-width: 120px;
        }
        .input-group input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--hover-color);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #1a7fc5;
        }
        .status-message {
            margin-top: 15px;
            font-style: italic;
            padding: 10px;
            border-radius: 5px;
            background-color: #e0e0e0;
        }
        .status-success {
            color: #388e3c;
            background-color: #c8e6c9;
        }
        .status-error {
            color: #d32f2f;
            background-color: #ffcdd2;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>GovBudgetTracker DApp</h1>
    <p style="text-align: center;">Transparently track government budgets on the blockchain.</p>

    <div class="section">
        <h3>Connect to MetaMask</h3>
        <div class="input-group">
            <button id="connectButton" class="btn-primary">Connect Wallet</button>
        </div>
        <p id="accountInfo" class="status-message">Status: Not connected.</p>
        <p>Admin Address: <span id="adminAddress">...</span></p>
    </div>

    <div class="section">
        <h3>Allocate Budget</h3>
        <p>Only the contract admin can perform this action.</p>
        <div class="input-group">
            <label for="allocateDeptId">Department/Project ID:</label>
            <input type="text" id="allocateDeptId" placeholder="e.g., 'health-project-1'">
        </div>
        <div class="input-group">
            <label for="allocateAmount">Amount (in ETH):</label>
            <input type="number" id="allocateAmount" placeholder="e.g., 500">
        </div>
        <button id="allocateButton" class="btn-primary">Allocate Budget</button>
        <p id="allocateStatus" class="status-message"></p>
    </div>
    
    <div class="section">
        <h3>Spend Funds</h3>
        <p>Spend funds from an allocated budget.</p>
        <div class="input-group">
            <label for="spendDeptId">Department/Project ID:</label>
            <input type="text" id="spendDeptId" placeholder="e.g., 'health-project-1'">
        </div>
        <div class="input-group">
            <label for="spendAmount">Amount (in ETH):</label>
            <input type="number" id="spendAmount" placeholder="e.g., 50">
        </div>
        <button id="spendButton" class="btn-secondary">Spend Funds</button>
        <p id="spendStatus" class="status-message"></p>
    </div>

    <div class="section">
        <h3>Audit Budget</h3>
        <p>Check the remaining budget for a department. Only the admin can do this.</p>
        <div class="input-group">
            <label for="auditDeptId">Department/Project ID:</label>
            <input type="text" id="auditDeptId" placeholder="e.g., 'health-project-1'">
        </div>
        <button id="auditButton" class="btn-secondary">Audit Budget</button>
        <p id="auditStatus" class="status-message"></p>
        <p>Remaining Budget: <span id="remainingAmount">...</span></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
    // ====================================================================
    // IMPORTANT: UPDATE THESE VALUES WITH YOUR DEPLOYED CONTRACT'S DETAILS
    // ====================================================================

    // Your smart contract's address after deployment.
    const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE";

    // Your contract's ABI as a JSON array. You must generate this
    // from your compiled GovBudgetTracker contract.
    const contractABI = [
        {
            "inputs": [],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "anonymous": false,
            "inputs": [
                { "indexed": true, "internalType": "string", "name": "deptId", "type": "string" },
                { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
            ],
            "name": "BudgetAllocated",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                { "indexed": true, "internalType": "string", "name": "deptId", "type": "string" },
                { "indexed": false, "internalType": "uint256", "name": "remainingAmount", "type": "uint256" }
            ],
            "name": "AuditPerformed",
            "type": "event"
        },
        {
            "anonymous": false,
            "inputs": [
                { "indexed": true, "internalType": "string", "name": "deptId", "type": "string" },
                { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" },
                { "indexed": false, "internalType": "address", "name": "spender", "type": "address" }
            ],
            "name": "FundsSpent",
            "type": "event"
        },
        {
            "inputs": [],
            "name": "admin",
            "outputs": [
                { "internalType": "address", "name": "", "type": "address" }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                { "internalType": "string", "name": "deptId", "type": "string" },
                { "internalType": "uint256", "name": "amount", "type": "uint256" }
            ],
            "name": "allocateBudget",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                { "internalType": "string", "name": "deptId", "type": "string" }
            ],
            "name": "auditBudget",
            "outputs": [
                { "internalType": "uint256", "name": "remaining", "type": "uint256" }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                { "internalType": "string", "name": "", "type": "string" }
            ],
            "name": "budgets",
            "outputs": [
                { "internalType": "uint256", "name": "allocatedAmount", "type": "uint256" },
                { "internalType": "uint256", "name": "spentAmount", "type": "uint256" },
                { "internalType": "bool", "name": "exists", "type": "bool" }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                { "internalType": "string", "name": "deptId", "type": "string" },
                { "internalType": "uint256", "name": "amount", "type": "uint256" }
            ],
            "name": "spendFunds",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        }
    ];

    let signer;
    let provider;
    let contract;

    const connectButton = document.getElementById("connectButton");
    const accountInfo = document.getElementById("accountInfo");
    const adminAddressSpan = document.getElementById("adminAddress");
    const allocateButton = document.getElementById("allocateButton");
    const spendButton = document.getElementById("spendButton");
    const auditButton = document.getElementById("auditButton");

    // Helper function to update status messages
    function setStatus(element, message, type = 'info') {
        element.textContent = message;
        element.className = `status-message status-${type}`;
    }

    // Function to connect to MetaMask
    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                const address = await signer.getAddress();
                setStatus(accountInfo, `Connected: ${address}`, 'success');

                const adminAddr = await contract.admin();
                adminAddressSpan.textContent = adminAddr;

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        setStatus(accountInfo, `Connected: ${accounts[0]}`, 'success');
                    } else {
                        setStatus(accountInfo, "Connection lost.", 'error');
                    }
                });
            } catch (error) {
                console.error("Connection error:", error);
                setStatus(accountInfo, `Error: ${error.message}`, 'error');
            }
        } else {
            alert("MetaMask is not installed. Please install it to use this app.");
        }
    }

    // Function to allocate budget
    async function allocateBudget() {
        if (!signer) {
            setStatus(document.getElementById("allocateStatus"), "Please connect your wallet first.", 'error');
            return;
        }
        const deptId = document.getElementById("allocateDeptId").value;
        const amountInEth = document.getElementById("allocateAmount").value;
        const status = document.getElementById("allocateStatus");
        
        if (!deptId || !amountInEth) {
            setStatus(status, "Please fill in all fields.", 'error');
            return;
        }

        try {
            const amountInWei = ethers.utils.parseEther(amountInEth);
            setStatus(status, "Allocating budget... Please confirm in MetaMask.", 'info');

            const tx = await contract.allocateBudget(deptId, amountInWei);
            await tx.wait();

            setStatus(status, `Budget for ${deptId} allocated successfully!`, 'success');
        } catch (error) {
            console.error("Allocation failed:", error);
            setStatus(status, `Error: ${error.message}`, 'error');
        }
    }

    // Function to spend funds
    async function spendFunds() {
        if (!signer) {
            setStatus(document.getElementById("spendStatus"), "Please connect your wallet first.", 'error');
            return;
        }
        const deptId = document.getElementById("spendDeptId").value;
        const amountInEth = document.getElementById("spendAmount").value;
        const status = document.getElementById("spendStatus");

        if (!deptId || !amountInEth) {
            setStatus(status, "Please fill in all fields.", 'error');
            return;
        }

        try {
            const amountInWei = ethers.utils.parseEther(amountInEth);
            setStatus(status, "Spending funds... Please confirm in MetaMask.", 'info');

            const tx = await contract.spendFunds(deptId, amountInWei);
            await tx.wait();

            setStatus(status, `Funds spent for ${deptId} successfully!`, 'success');
        } catch (error) {
            console.error("Spending failed:", error);
            setStatus(status, `Error: ${error.message}`, 'error');
        }
    }

    // Function to audit budget
    async function auditBudget() {
        if (!contract) {
            setStatus(document.getElementById("auditStatus"), "Please connect your wallet first.", 'error');
            return;
        }
        const deptId = document.getElementById("auditDeptId").value;
        const status = document.getElementById("auditStatus");
        const remainingAmountSpan = document.getElementById("remainingAmount");

        if (!deptId) {
            setStatus(status, "Please enter a department ID.", 'error');
            return;
        }
        
        try {
            setStatus(status, "Auditing budget...", 'info');
            const remainingWei = await contract.auditBudget(deptId);
            const remainingEth = ethers.utils.formatEther(remainingWei);
            remainingAmountSpan.textContent = `${remainingEth} ETH`;
            setStatus(status, `Audit successful for ${deptId}.`, 'success');
        } catch (error) {
            console.error("Audit failed:", error);
            remainingAmountSpan.textContent = "...";
            setStatus(status, `Error: ${error.message}`, 'error');
        }
    }

    // Attach event listeners
    connectButton.addEventListener("click", connectWallet);
    allocateButton.addEventListener("click", allocateBudget);
    spendButton.addEventListener("click", spendFunds);
    auditButton.addEventListener("click", auditBudget);
</script>

</body>
</html>
